name: Déployer sur Kubernetes

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Récupérer le code
      uses: actions/checkout@v2

    - name: Configurer l'outil de ligne de commande Google Cloud
      env:
        GOOGLE_APPLICATION_CREDENTIALS: ${{ secrets.GCP_SA_KEY }}
      run: |
        # Installer l'outil de ligne de commande gcloud
        curl -sSL https://sdk.cloud.google.com | bash
        exec -l $SHELL
        gcloud auth activate-service-account --key-file=$GOOGLE_APPLICATION_CREDENTIALS
        gcloud config set project elevated-apex-403206
        gcloud config set account env-test@elevated-apex-403206.iam.gserviceaccount.com

    - name: Récupérer les informations du cluster Kubernetes
      run: |
        gcloud container clusters get-credentials env-test-stage --region us-east1 --project elevated-apex-403206

    - name: Déployer l'application Kubernetes
      run: |
        kubectl apply -f kubernetes/front.yml
